

<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Integrate a mosaic mouse brain dataset &mdash; spamosaic v1.0.3 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../_static/nbsphinx-code-cells.css?v=2aa19091" />
      <link rel="stylesheet" type="text/css" href="../../../_static/custom.css?v=9af0dbfa" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js?v=393fe109"></script>
      <script src="../../../_static/doctools.js?v=888ff710"></script>
      <script src="../../../_static/sphinx_highlight.js?v=4825356b"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
      <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
      <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Integrate a mosaic tonsil dataset" href="Human_tonsil_rna%2Badt.html" />
    <link rel="prev" title="Integrate a simulated mosaic dataset" href="Simulations_with_batch_effects.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            spamosaic
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../install.html">Installation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../index.html">Tutorials</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../horizontal/index.html">Horizontal Integration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../vertical/index.html">Vertical Integration</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Mosaic Integration</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="Simulations_with_batch_effects.html">Integrate a simulated mosaic dataset</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Integrate a mosaic mouse brain dataset</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#preprocessing">preprocessing</a></li>
<li class="toctree-l4"><a class="reference internal" href="#training">training</a></li>
<li class="toctree-l4"><a class="reference internal" href="#inference">inference</a></li>
<li class="toctree-l4"><a class="reference internal" href="#clustering">clustering</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="Human_tonsil_rna%2Badt.html">Integrate a mosaic tonsil dataset</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../imputation/index.html">Imputation</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../spamosaic.html">API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dataset.html">Datasets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../credits.html">Credits</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">spamosaic</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Tutorials</a></li>
          <li class="breadcrumb-item"><a href="index.html">Mosaic Integration</a></li>
      <li class="breadcrumb-item active">Integrate a mosaic mouse brain dataset</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../_sources/tutorials/integration/mosaic/Mouse_postnatal_brain_rna+H3K4me3.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="Integrate-a-mosaic-mouse-brain-dataset">
<h1>Integrate a mosaic mouse brain dataset<a class="headerlink" href="#Integrate-a-mosaic-mouse-brain-dataset" title="Permalink to this heading"></a></h1>
<p>In this notebook, we used SpaMosaic to integrate a postnatal mouse brain dataset. It has three sections where the first section consists of RNA and histone modification (H3K4me3) profiles while the second only has RNA expression and the third only has histone modification (H3K4me3) expression.</p>
<p>Data used in this notebook can be downloaded from <a class="reference external" href="https://drive.google.com/drive/folders/10ySKpZXvl7ryC8GpSKyzovvC1pg2xVC2?usp=drive_link">google drive</a>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">scanpy</span> <span class="k">as</span> <span class="nn">sc</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">join</span>

<span class="kn">from</span> <span class="nn">spamosaic.framework</span> <span class="kn">import</span> <span class="n">SpaMosaic</span>

<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;CUBLAS_WORKSPACE_CONFIG&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;:4096:8&#39;</span>  <span class="c1"># for CuBLAS operation and you have CUDA &gt;= 10.2</span>
<span class="kn">import</span> <span class="nn">spamosaic.utils</span> <span class="k">as</span> <span class="nn">utls</span>
<span class="kn">from</span> <span class="nn">spamosaic.preprocessing</span> <span class="kn">import</span> <span class="n">RNA_preprocess</span><span class="p">,</span> <span class="n">ADT_preprocess</span><span class="p">,</span> <span class="n">Epigenome_preprocess</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ad1_rna</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">read_h5ad</span><span class="p">(</span><span class="s1">&#39;./s1_adata_rna.h5ad&#39;</span><span class="p">)</span>
<span class="n">ad1_epi</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">read_h5ad</span><span class="p">(</span><span class="s1">&#39;./s1_adata_H3K4me3.h5ad&#39;</span><span class="p">)</span>
<span class="n">ad2_rna</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">read_h5ad</span><span class="p">(</span><span class="s1">&#39;./s2_adata_rna.h5ad&#39;</span><span class="p">)</span>
<span class="n">ad3_epi</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">read_h5ad</span><span class="p">(</span><span class="s1">&#39;./s3_adata_H3K4me3.h5ad&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<section id="preprocessing">
<h2>preprocessing<a class="headerlink" href="#preprocessing" title="Permalink to this heading"></a></h2>
<p>SpaMosaic expects batch-corrected low-dimensional representations for each modality as input. Therefore, for the raw count assays of each modality, SpaMosaic performs feature selection and dimension reduction to obtain the low-dimensional representations. Then, Harmony is performed to integrate these representations in each modality (optional, depending on the presence of strong batch effects).</p>
<p>In mosaic integration, SpaMosaic requires the input dataset in the following format:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="s1">&#39;rna&#39;</span><span class="p">:</span>      <span class="p">[</span><span class="n">adata1_rna</span><span class="p">,</span> <span class="n">adata2_rna</span><span class="p">,</span>   <span class="kc">None</span><span class="p">,</span>         <span class="n">adata4_rna</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span>
    <span class="s1">&#39;protein&#39;</span><span class="p">:</span>  <span class="p">[</span><span class="n">adata1_adt</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>         <span class="n">adata3_adt</span><span class="p">,</span>   <span class="kc">None</span><span class="p">,</span>       <span class="o">...</span><span class="p">],</span>
    <span class="s1">&#39;atac&#39;</span><span class="p">:</span>     <span class="p">[</span><span class="kc">None</span><span class="p">,</span>       <span class="n">adata2_atac</span><span class="p">,</span>  <span class="kc">None</span><span class="p">,</span>         <span class="kc">None</span><span class="p">,</span>       <span class="o">...</span><span class="p">],</span>
    <span class="s1">&#39;histone&#39;</span><span class="p">:</span>  <span class="p">[</span><span class="kc">None</span><span class="p">,</span>       <span class="kc">None</span>      <span class="p">,</span>   <span class="n">adata3_hist</span><span class="p">,</span>  <span class="kc">None</span><span class="p">,</span>       <span class="o">...</span><span class="p">],</span>
    <span class="o">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>In the dictionary, each key represents a modality and each modality key corresponds to list of <code class="docutils literal notranslate"><span class="pre">anndata</span></code> objects. Each <code class="docutils literal notranslate"><span class="pre">anndata</span></code> object contains modality-specific information for a particular section. For example, the first object <code class="docutils literal notranslate"><span class="pre">adata1_rna</span></code> under the ‘rna’ key holds the RNA profiles for the first section, while the first object <code class="docutils literal notranslate"><span class="pre">adata1_adt</span></code> under the ‘protein’ key holds protein profiles for the same section. If a section is not measured for a particular modality, its value in the list
is <code class="docutils literal notranslate"><span class="pre">None</span></code>. For instance, the first element under the ‘atac’ and ‘histone’ keys is <code class="docutils literal notranslate"><span class="pre">None</span></code>, indicating that the first section was not measured with ATAC or histone modality. All lists have the same length, which corresponds to the number of sections in the target dataset.</p>
<p>SpaMosaic employs contrastive learning to capture the relationships between modalities. To achieve this, it requires the modalities in a mosaic dataset to be directly or indirectly connected through one or multiple sections. If a pair of modalities occur in the same section, there is a direct connection between this pair of modalities, while an indirect connection requires multiple intermediary direct connections.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># for this dataset, we have</span>
<span class="n">input_dict</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;rna&#39;</span><span class="p">:</span>     <span class="p">[</span><span class="n">ad1_rna</span><span class="p">,</span> <span class="n">ad2_rna</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span>
    <span class="s1">&#39;H3K4me3&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">ad1_epi</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>    <span class="n">ad3_epi</span><span class="p">]</span>
<span class="p">}</span>

<span class="n">input_key</span> <span class="o">=</span> <span class="s1">&#39;dimred_bc&#39;</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ad1_rna</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
AnnData object with n_obs × n_vars = 9548 × 21536
    obs: &#39;src&#39;
    obsm: &#39;spatial&#39;
    layers: &#39;counts&#39;
</pre></div></div>
</div>
<p>Parameters in the following <code class="docutils literal notranslate"><span class="pre">RNA_preprocess</span></code> and <code class="docutils literal notranslate"><span class="pre">Epigenome_preprocess</span></code> function:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">batch_corr</span></code>: whether to perform batch correction with Harmony</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">n_hvg</span></code>/<code class="docutils literal notranslate"><span class="pre">n_peak</span></code>: how many highly variable genes/peaks to select</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">batch_key</span></code>: the key in the row metadata that holds the batch labels</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">key</span></code>: the key in <code class="docutils literal notranslate"><span class="pre">.obsm</span></code> that will hold the output low-dimensional representations</p></li>
</ul>
<p>After preprocessing, the low-dimensional representations can be accessed by: <code class="docutils literal notranslate"><span class="pre">ad1_rna.obsm[input_key]</span></code>, <code class="docutils literal notranslate"><span class="pre">ad1_epi.obsm[input_key]</span></code>, <code class="docutils literal notranslate"><span class="pre">ad2_rna.obsm[input_key]</span></code>…</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">RNA_preprocess</span><span class="p">(</span><span class="n">input_dict</span><span class="p">[</span><span class="s1">&#39;rna&#39;</span><span class="p">],</span> <span class="n">batch_corr</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">n_hvg</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span> <span class="n">batch_key</span><span class="o">=</span><span class="s1">&#39;src&#39;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">input_key</span><span class="p">)</span>
<span class="n">Epigenome_preprocess</span><span class="p">(</span><span class="n">input_dict</span><span class="p">[</span><span class="s1">&#39;H3K4me3&#39;</span><span class="p">],</span> <span class="n">batch_corr</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">n_peak</span><span class="o">=</span><span class="mi">50000</span><span class="p">,</span> <span class="n">batch_key</span><span class="o">=</span><span class="s1">&#39;src&#39;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">input_key</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Use GPU mode.
        Initialization is completed.
        Completed 1 / 10 iteration(s).
        Completed 2 / 10 iteration(s).
        Completed 3 / 10 iteration(s).
Reach convergence after 3 iteration(s).
Use GPU mode.
        Initialization is completed.
        Completed 1 / 10 iteration(s).
        Completed 2 / 10 iteration(s).
Reach convergence after 2 iteration(s).
</pre></div></div>
</div>
</section>
<section id="training">
<h2>training<a class="headerlink" href="#training" title="Permalink to this heading"></a></h2>
<p>SpaMosaic employs modality-specific graph neural networks to embed each modality’s input into latent space. In horizontal integration, all sections have only one modality, thus each section has only one set of embeddings.</p>
<p>The crucial parameters include:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">intra_knns</span></code>: how many nearest neighbors to consider when searching for spatial neighbors within each section (list or integer)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">inter_knn_base</span></code>: how many nearest neighbors to consider when searching for mutual nearest neighbors between sections (integer)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">w_g</span></code>: the weight for spatial-adjacency graph</p></li>
</ul>
<p>The following parameters are recommended to use in complex integration scenarios, like varying resolution or size across sections</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">smooth_input</span></code>: whethere to smooth the input representations (bool)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">smooth_L</span></code>: number of LGCN layers for smoothing input</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">inter_auto_knn</span></code>: whether to automatically balance the kNN during MNN searching (bool)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">rmv_outlier</span></code>: whether to remove outlier of MNN (bool)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">contamination</span></code>: percentage of removed MNN outlier</p></li>
</ul>
<p>for training:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">net</span></code>: which graph neural network to use (only support wlgcn now)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">lr</span></code>: learning rate</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">n_epochs</span></code>: number of training epochs</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">w_rec_g</span></code>: the loss weight for reconstructing original graph structure. If the target dataset contains protein modality, we recommend a low value for w_rec_g (e.g., 0); if it contains epigenome modality, we recommend a high value for w_rec_g (e.g., 1).</p></li>
</ul>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">SpaMosaic</span><span class="p">(</span>
    <span class="n">modBatch_dict</span><span class="o">=</span><span class="n">input_dict</span><span class="p">,</span> <span class="n">input_key</span><span class="o">=</span><span class="n">input_key</span><span class="p">,</span>
    <span class="n">batch_key</span><span class="o">=</span><span class="s1">&#39;src&#39;</span><span class="p">,</span> <span class="n">intra_knns</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">inter_knn_base</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">w_g</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
    <span class="n">seed</span><span class="o">=</span><span class="mi">1234</span><span class="p">,</span>
    <span class="n">device</span><span class="o">=</span><span class="s1">&#39;cuda:0&#39;</span>
<span class="p">)</span>

<span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">net</span><span class="o">=</span><span class="s1">&#39;wlgcn&#39;</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">n_epochs</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
batch0: [&#39;rna&#39;, &#39;H3K4me3&#39;]
batch1: [&#39;rna&#39;]
batch2: [&#39;H3K4me3&#39;]
------Calculating spatial graph...
The graph contains 95480 edges, 9548 cells.
10.0000 neighbors per cell on average.
------Calculating spatial graph...
The graph contains 93700 edges, 9370 cells.
10.0000 neighbors per cell on average.
------Calculating spatial graph...
The graph contains 95480 edges, 9548 cells.
10.0000 neighbors per cell on average.
------Calculating spatial graph...
The graph contains 24990 edges, 2499 cells.
10.0000 neighbors per cell on average.
Searching MNN within rna
Finding MNN between (mult, rna) using KNN (10, 10)
Number of mnn pairs for rna:12129
Searching MNN within H3K4me3
Finding MNN between (mult, atac) using KNN (10, 10)
Number of mnn pairs for H3K4me3:8201
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████████████████████████████████████████████████| 100/100 [00:05&lt;00:00, 18.35it/s]
</pre></div></div>
</div>
</section>
<section id="inference">
<h2>inference<a class="headerlink" href="#inference" title="Permalink to this heading"></a></h2>
<p>After training, SpaMosaic can infer the modality-specific embedding for each section. These embeddings will be directly saved in original <code class="docutils literal notranslate"><span class="pre">anndata</span></code> objects. For example, the RNA-specific embeddings can be accessed by <code class="docutils literal notranslate"><span class="pre">ad1_rna.obsm['emb']</span></code>, <code class="docutils literal notranslate"><span class="pre">ad2_rna.obsm['emb']</span></code>, the histone modification-specific embeddings can be accessed by <code class="docutils literal notranslate"><span class="pre">ad1_epi.obsm['emb']</span></code>, <code class="docutils literal notranslate"><span class="pre">ad3_epi.obsm['emb']</span></code>.</p>
<p>The following <code class="docutils literal notranslate"><span class="pre">infer_emb</span></code> function will return a new list of <code class="docutils literal notranslate"><span class="pre">anndata</span></code> objects, which save the final/merged embeddings for spatial clustering. The final embeddings can be accessed by <code class="docutils literal notranslate"><span class="pre">ad_embs[0].obsm['merged_emb']</span></code>, <code class="docutils literal notranslate"><span class="pre">ad_embs[1].obsm['merged_emb']</span></code>, …</p>
<p>In mosaic integration, the final merged embeddings are obtained by averaging the modality-specific embeddings.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ad_embs</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">infer_emb</span><span class="p">(</span><span class="n">input_dict</span><span class="p">,</span> <span class="n">emb_key</span><span class="o">=</span><span class="s1">&#39;emb&#39;</span><span class="p">,</span> <span class="n">final_latent_key</span><span class="o">=</span><span class="s1">&#39;merged_emb&#39;</span><span class="p">)</span>
<span class="n">ad_mosaic</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">ad_embs</span><span class="p">)</span>
<span class="n">ad_mosaic</span> <span class="o">=</span> <span class="n">utls</span><span class="o">.</span><span class="n">get_umap</span><span class="p">(</span><span class="n">ad_mosaic</span><span class="p">,</span> <span class="n">use_reps</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;merged_emb&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/yanxh/anaconda3/envs/spamosaic-env/lib/python3.8/site-packages/tqdm/auto.py:21: TqdmWarning: IProgress not found. Please update jupyter and ipywidgets. See https://ipywidgets.readthedocs.io/en/stable/user_install.html
  from .autonotebook import tqdm as notebook_tqdm
</pre></div></div>
</div>
<p>Visualize the final embeddings using UMAP plots, spot are colored by batch labels</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">utls</span><span class="o">.</span><span class="n">plot_basis</span><span class="p">(</span><span class="n">ad_mosaic</span><span class="p">,</span> <span class="n">basis</span><span class="o">=</span><span class="s1">&#39;merged_emb_umap&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;src&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../../_images/tutorials_integration_mosaic_Mouse_postnatal_brain_rna%2BH3K4me3_17_0.png" src="../../../_images/tutorials_integration_mosaic_Mouse_postnatal_brain_rna%2BH3K4me3_17_0.png" />
</div>
</div>
</section>
<section id="clustering">
<h2>clustering<a class="headerlink" href="#clustering" title="Permalink to this heading"></a></h2>
<p>Parameters for the following <code class="docutils literal notranslate"><span class="pre">utls.clustering</span></code> function:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">n_cluster</span></code>: expected number of clusters</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">used_obsm</span></code>: the target key in the <code class="docutils literal notranslate"><span class="pre">ad_mosaic.obsm</span></code> that holds the embeddings for clustering input</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">algo</span></code>: which clustering algorithm to use, <code class="docutils literal notranslate"><span class="pre">mclust</span></code> or <code class="docutils literal notranslate"><span class="pre">kmeans</span></code>. Sometimes <code class="docutils literal notranslate"><span class="pre">mclust</span></code> can fail to output clustering, it will automatically output the <code class="docutils literal notranslate"><span class="pre">kmeans</span></code> outputs.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">key</span></code>: the key in the row metadata that will hold the output clustering labels.</p></li>
</ul>
<p>Generally, SpaMosaic works better with the mclust algorithm in spatial domain identification task. The final/merged embeddings are used as input for mclust and the clustering labels can be accessed by <code class="docutils literal notranslate"><span class="pre">ad_mosaic.obs['mclust']</span></code>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">utls</span><span class="o">.</span><span class="n">clustering</span><span class="p">(</span><span class="n">ad_mosaic</span><span class="p">,</span> <span class="n">n_cluster</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">used_obsm</span><span class="o">=</span><span class="s1">&#39;merged_emb&#39;</span><span class="p">,</span> <span class="n">algo</span><span class="o">=</span><span class="s1">&#39;mclust&#39;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;mclust&#39;</span><span class="p">)</span>
<span class="n">utls</span><span class="o">.</span><span class="n">split_adata_ob</span><span class="p">(</span><span class="n">ad_embs</span><span class="p">,</span> <span class="n">ad_mosaic</span><span class="p">,</span> <span class="s1">&#39;obs&#39;</span><span class="p">,</span> <span class="s1">&#39;mclust&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
R[write to console]:                    __           __
   ____ ___  _____/ /_  _______/ /_
  / __ `__ \/ ___/ / / / / ___/ __/
 / / / / / / /__/ / /_/ (__  ) /_
/_/ /_/ /_/\___/_/\__,_/____/\__/   version 6.0.0
Type &#39;citation(&#34;mclust&#34;)&#39; for citing this R package in publications.

</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
fitting ...
  |======================================================================| 100%
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">utls</span><span class="o">.</span><span class="n">plot_basis</span><span class="p">(</span><span class="n">ad_mosaic</span><span class="p">,</span> <span class="n">basis</span><span class="o">=</span><span class="s1">&#39;merged_emb_umap&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;src&#39;</span><span class="p">,</span> <span class="s1">&#39;mclust&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../../_images/tutorials_integration_mosaic_Mouse_postnatal_brain_rna%2BH3K4me3_21_0.png" src="../../../_images/tutorials_integration_mosaic_Mouse_postnatal_brain_rna%2BH3K4me3_21_0.png" />
</div>
</div>
<p>Spatial plots of clustering label for individual sections</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sizes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">30</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">100</span><span class="p">]</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ad</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ad_embs</span><span class="p">):</span>
    <span class="n">utls</span><span class="o">.</span><span class="n">plot_basis</span><span class="p">(</span><span class="n">ad</span><span class="p">,</span> <span class="s1">&#39;spatial&#39;</span><span class="p">,</span> <span class="s1">&#39;mclust&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">sizes</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../../_images/tutorials_integration_mosaic_Mouse_postnatal_brain_rna%2BH3K4me3_23_0.png" src="../../../_images/tutorials_integration_mosaic_Mouse_postnatal_brain_rna%2BH3K4me3_23_0.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../../_images/tutorials_integration_mosaic_Mouse_postnatal_brain_rna%2BH3K4me3_23_1.png" src="../../../_images/tutorials_integration_mosaic_Mouse_postnatal_brain_rna%2BH3K4me3_23_1.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../../_images/tutorials_integration_mosaic_Mouse_postnatal_brain_rna%2BH3K4me3_23_2.png" src="../../../_images/tutorials_integration_mosaic_Mouse_postnatal_brain_rna%2BH3K4me3_23_2.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="Simulations_with_batch_effects.html" class="btn btn-neutral float-left" title="Integrate a simulated mosaic dataset" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="Human_tonsil_rna%2Badt.html" class="btn btn-neutral float-right" title="Integrate a mosaic tonsil dataset" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright .</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>